<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layout}">
<head>
<title>Phân quyền chức năng</title>
<th:block layout:fragment="styles">
	<link rel="stylesheet" href="/styles/css/admin/main.css">
</th:block>
</head>
<body>
	<div layout:fragment="content">

		<!-- Tìm kiếm + Lọc -->
		<div class="search-filter-container">
			<form th:action="@{/admin/permissions}" method="get">
				<div class="search-box">
					<input type="text" name="keyword"
						placeholder="Tìm kiếm theo tên, email, hoặc username..."
						th:value="${keyword}">
					<button type="submit">
						<i class="fas fa-search"></i> Tìm kiếm
					</button>
				</div>

				<div class="filter-group">
					<div class="filter-item">
						<label for="statusFilter">Trạng thái:</label> <select
							id="statusFilter" name="status" onchange="this.form.submit()">
							<option value="">Tất cả</option>
							<option value="1" th:selected="${status == '1'}">Hoạt
								động</option>
							<option value="0" th:selected="${status == '0'}">Ngừng
								hoạt động</option>
							<option value="-1" th:selected="${status == '-1'}">Bị
								khóa</option>
						</select>
					</div>
					<div class="filter-item">
						<label for="roleFilter">Vai trò:</label> <select id="roleFilter"
							name="roleId" onchange="this.form.submit()">
							<option value="">Tất cả</option>
							<option th:each="role : ${roles}" th:value="${role.roleId}"
								th:text="${role.roleName.displayName}"
								th:selected="${roleId == role.roleId}"></option>
						</select>
					</div>
				</div>
			</form>
		</div>

		<div class="user-role-container">
			<!-- Bảng người dùng -->
			<div class="user-table">
				<table>
					<tr th:each="user : ${users}">
						<td th:text="${user.username}">Username</td>
						<td><select th:field="*{userRoles[user.userId]}">
								<option th:each="role : ${roles}" th:value="${role.roleId}"
									th:text="${role.roleName}"></option>
						</select></td>
						<td>
							<button type="button"
								th:onclick="'loadPermissions(' + ${user.userId} + ')'">Xem
								quyền</button>
						</td>
					</tr>
				</table>
			</div>

			<!-- Bảng phân quyền chức năng -->
			<div class="permission-table" id="permissionTable">
				<form th:action="@{/admin/permissions/update}" method="post">
					<input type="hidden" name="userId" id="permUserId" />
					<table>
						<tr th:each="perm : ${permissions}">
							<td><input type="checkbox" name="permissionIds"
								th:value="${perm.permissionId}" th:checked="${perm.assigned}" />
							</td>
							<td th:text="${perm.name}"></td>
						</tr>
					</table>
					<button type="submit">Cập nhật quyền</button>
				</form>
			</div>
		</div>


	</div>

	<th:block layout:fragment="scripts">
		<script>
        function toggleStatus(checkbox) {
            const userId = checkbox.getAttribute('data-id');
            fetch('/admin/users/toggle-status/' + userId)
                .then(() => location.reload())
                .catch(err => console.error(err));
        }
    </script>
	</th:block>

</body>
</html>
