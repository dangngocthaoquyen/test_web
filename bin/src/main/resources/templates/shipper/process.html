<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý kho - 4Petals</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link th:href="@{/styles/css/shipper/main.css}" rel="stylesheet">
<link th:href="@{/styles/css/shipper/sidebar.css}" rel="stylesheet">
<link th:href="@{/styles/css/shipper/header.css}" rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
<link
	href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
	rel="stylesheet">
</head>
<body>
	<div class="dashboard-container">

		<!-- Thanh bên trái -->
		<div th:replace="~{shipper/sidebar :: sidebar}"></div>
		<div th:replace="~{shipper/header :: header}"></div>

		<!-- Nội dung chính -->
		<div class="main-content show">
			<div id="content-section" class="content-box mt-4 mx-3 p-4">
				<h5 class="fw-bold text-danger">Danh sách đơn hàng đang xử lý</h5>

				<!-- Form bao quanh bảng -->
				<form id="orderForm" th:action="@{/shipper/updateOrders}" method="post">
					<table class="table table-bordered mt-3 align-middle text-center">
						<thead class="table-success">
							<tr>
								<th>STT</th>
								<th>Mã đơn hàng</th>
								<th>Tên khách hàng</th>
								<th>Trạng thái</th>
								<th>Ghi chú</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="order, iStat : ${listOrders}">
								<td th:text="${iStat.count}"></td>
								<td th:text="${order.maDH}"></td>
								<td
									th:text="${order.khachHang != null ? order.khachHang.hoTen : 'Chưa có'}"></td>

								<!-- Cột trạng thái -->
								<td class="text-center">
									<select class="form-select form-select-sm text-center"
										th:id="'status-' + ${order.maDH}"
										th:name="'status-' + ${order.maDH}"
										onchange="kiemTraGhiChu(this)">
										<option value="dang_giao"
											th:selected="${order.trangThai == 'dang_giao'}">Đang giao</option>
										<option value="thanh_cong"
											th:selected="${order.trangThai == 'thanh_cong'}">Giao hàng thành công</option>
										<option value="that_bai"
											th:selected="${order.trangThai == 'that_bai'}">Giao hàng thất bại</option>
									</select>
								</td>

								<!-- Cột ghi chú -->
								<td class="text-center">
									<input type="text" class="form-control form-control-sm text-center"
										placeholder="Nhập ghi chú (nếu có)"
										th:id="'note-' + ${order.maDH}"
										th:name="'note-' + ${order.maDH}"
										th:value="${order.ghiChu}">
								</td>
							</tr>
						</tbody>
					</table>

					<!-- ✅ Nút Lưu và Hủy ở cuối form -->
					<div class="d-flex justify-content-end mt-3 gap-2">
						<button type="submit" class="btn btn-success px-4">
							<i class="fa-solid fa-floppy-disk me-1"></i> Lưu
						</button>
						<button type="button" class="btn btn-secondary px-4" id="btnCancel">
							<i class="fa-solid fa-xmark me-1"></i> Hủy
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		function kiemTraGhiChu(selectElement) {
			const maDH = selectElement.id.replace("status-", "");
			const ghiChuInput = document.getElementById("note-" + maDH);
			const giaTri = selectElement.value;

			if (giaTri === "that_bai") {
				ghiChuInput.required = true;
				ghiChuInput.placeholder = "❗ Bắt buộc nhập lý do thất bại";
				ghiChuInput.classList.add("border-danger");
			} else {
				ghiChuInput.required = false;
				ghiChuInput.placeholder = "Nhập ghi chú (nếu có)";
				ghiChuInput.classList.remove("border-danger");
			}
		}

		// ✅ Kiểm tra trước khi submit
		document.getElementById("orderForm").addEventListener("submit", function(e) {
			let hopLe = true;
			document.querySelectorAll("select.form-select").forEach(select => {
				const maDH = select.id.replace("status-", "");
				const note = document.getElementById("note-" + maDH);

				if (select.value === "that_bai" && note.value.trim() === "") {
					note.classList.add("border-danger");
					hopLe = false;
				} else {
					note.classList.remove("border-danger");
				}
			});

			if (!hopLe) {
				e.preventDefault();
				alert("Nếu chọn 'Giao hàng thất bại' thì ghi chú không được để trống!");
			}
		});

		// ✅ Nút Hủy — reset toàn bộ form
		document.getElementById("btnCancel").addEventListener("click", function() {
			document.getElementById("orderForm").reset();
			document.querySelectorAll(".border-danger").forEach(el => el.classList.remove("border-danger"));
		});
	</script>
</body>
</html>
