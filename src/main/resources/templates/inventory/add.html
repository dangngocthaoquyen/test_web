
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý kho - 4Petals</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link th:href="@{/styles/css/inventory/dashboard.css}" rel="stylesheet">
<link th:href="@{/styles/css/inventory/sidebar.css}" rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
<link
	href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
	rel="stylesheet">
<script>
        // Hàm để tải danh sách đơn hàng bằng AJAX (thay đổi nội dung bảng)
        function showOrders() {
            fetch('/orders/list') // endpoint controller trả về HTML hoặc JSON
                .then(response => response.text())
                .then(html => {
                    document.getElementById('content-section').innerHTML = html;
                });
        }

        function showProducts() {
            fetch('/products/list')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('content-section').innerHTML = html;
                });
        }
    </script>
</head>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<body>
	<div class="dashboard-container">

		<!-- Thanh bên trái -->
		<div th:replace="~{inventory/sidebar :: sidebar}"></div>

		<!-- Nội dung chính -->
		<div class="main-content show">

			<!-- Bảng Phiếu Nhập -->
			<div class="content-box mt-4 mx-3 p-4">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h5 class="fw-bold text-danger">Danh sách Phiếu Nhập</h5>
					<button class="btn btn-success" type="button"
						data-bs-toggle="collapse" data-bs-target="#formPhieuNhap">
						Nhập Phiếu Nhập</button>
				</div>

				<!-- Form nhập phiếu nhập -->
				<div class="collapse mb-3" id="formPhieuNhap">
					<div class="card card-body">
						<form th:action="@{/inventory/add}" method="post">
							<div class="mb-2">
								<label>Mã Phiếu Nhập</label> <input type="text"
									class="form-control" name="maPN" th:value="${nextMaPhieuNhap}"
									readonly>
							</div>
							<div class="mb-2">
								<label>Ngày Nhập</label> <input type="date" class="form-control"
									name="ngayNhap"
									th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
									required>

							</div>

							<div class="mb-2">
								<label>Tổng Tiền</label> <input type="number"
									class="form-control" name="tongTien" th:value="0" readonly>
							</div>
							<div class="mb-2">
								<label>Nhà Cung Cấp</label> <select class="form-select"
									name="maNCC" required>
									<!-- <option value="">Chọn nhà cung cấp</option> -->
									<option th:each="ncc : ${dsNCC}" th:value="${ncc.maNCC}"
										th:text="${ncc.tenNCC}"></option>
								</select>
							</div>

							<div class="mb-2">
								<label>Nhân Viên Lập Phiếu</label> <input type="text"
									class="form-control" name="tenNV" th:value="${tenNV}" readonly>
								<input type="hidden" name="maNV" th:value="${maNV}">
							</div>

							<button type="submit" class="btn btn-primary">Lưu Phiếu
								Nhập</button>
						</form>
					</div>
				</div>


				<!-- Bảng hiển thị phiếu nhập -->
				<table class="table table-bordered mt-3 align-middle text-center">
					<thead class="table-success">
						<tr>
							<th>STT</th>
							<th>Mã Phiếu Nhập</th>
							<th>Ngày Nhập</th>
							<th>Tổng Tiền</th>
							<th>Nhà Cung Cấp</th>
							<th>Nhân Viên Lập Phiếu</th>
							<th>Thao tác</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="pn, iStat : ${listPhieuNhap}">
							<td th:text="${iStat.count}"></td>
							<td th:text="${pn.maPN}"></td>
							<td th:text="${#dates.format(pn.ngayNhap,'yyyy-MM-dd')}"></td>
							<td
								th:text="${#numbers.formatDecimal(pn.tongTien,0,'COMMA',3,'POINT')}"></td>

							<!-- Hiển thị tên nhà cung cấp -->
							<td th:text="${pn.nhaCungCap.tenNCC}"></td>

							<!-- Hiển thị họ tên nhân viên -->
							<td th:text="${pn.nhanVien.hoTen}"></td>

							<td><a href="#"
								th:onclick="'editPhieuNhap(' + ${pn.maPN} + ')'"
								class="text-primary me-2"> <i
									class="fa-solid fa-pen-to-square"></i>
							</a> <a href="#" th:onclick="'deletePhieuNhap(' + ${pn.maPN} + ')'"
								class="text-danger"> <i class="fa-solid fa-trash"></i>
							</a></td>
						</tr>
					</tbody>
				</table>


				<!-- Bảng Chi Tiết Phiếu Nhập -->
				<div class="content-box mt-4 mx-3 p-4">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="fw-bold text-danger">Chi Tiết Phiếu Nhập</h5>
						<button class="btn btn-success" type="button"
							data-bs-toggle="collapse" data-bs-target="#formChiTiet">
							Nhập Chi Tiết Phiếu Nhập</button>
					</div>

					<!-- Form nhập chi tiết phiếu nhập -->
					<div class="collapse mb-3" id="formChiTiet">
						<div class="card card-body">
							<form th:action="@{/inventory/detail/add}" method="post">
								<div class="mb-2">
									<label>Mã Phiếu Nhập</label> <select id="phieuNhap"
										class="form-select" name="phieuNhap" required>
										<!-- <option value="">-- Chọn phiếu nhập --</option> -->
										<option th:each="pn : ${listPhieuNhap}" th:value="${pn.maPN}"
											th:text="${pn.maPN}"></option>
									</select>
								</div>
								<div class="mb-2">
									<label>Nguyên Liệu</label> <select id="nguyenLieu"
										class="form-select" name="nguyenLieu" required>
										<!-- <option value="">-- Chọn nguyên liệu --</option> -->
									</select>
								</div>
								<div class="mb-2">
									<label>Số Lượng</label> <input type="number"
										class="form-control" name="soLuong" min="1" required>
								</div>
								<div class="mb-2">
									<label>Giá Nhập</label> <input type="number"
										class="form-control" name="giaNhap" min="0" required>
								</div>
								<button type="submit" class="btn btn-primary">Lưu Chi
									Tiết</button>
							</form>
						</div>
					</div>
					<script>
document.getElementById("maPhieuNhap").addEventListener("change", function() {
    const maPhieuNhap = this.value;
    if (!maPhieuNhap) return;

    fetch(`/inventory/getMaterialsByPhieuNhap/${maPhieuNhap}`)
        .then(res => res.json())
        .then(data => {
            const selectNguyenLieu = document.getElementById("nguyenLieu");
            selectNguyenLieu.innerHTML = '<option value="">-- Chọn nguyên liệu --</option>';
            data.forEach(nl => {
                const opt = document.createElement("option");
                opt.value = nl.maNguyenLieu;
                opt.textContent = nl.tenNguyenLieu;
                selectNguyenLieu.appendChild(opt);
            });
        })
        .catch(err => console.error("Lỗi khi tải danh sách nguyên liệu:", err));
});
</script>


					<!-- Bảng hiển thị chi tiết phiếu nhập -->
					<table class="table table-bordered mt-3 align-middle text-center">
						<thead class="table-success">
							<tr>
								<th>STT</th>
								<th>Mã Phiếu Nhập</th>
								<th>Tên Nguyên Liệu</th>
								<th>Số Lượng</th>
								<th>Giá Nhập</th>
								<th>Thành Tiền</th>
								<th>Thao Tác</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="ct, iStat : ${listChiTiet}">
								<td th:text="${iStat.count}"></td>
								<td th:text="${ct.phieuNhap.maPN}"></td>
								<td th:text="${ct.nguyenLieu.nguyenLieu}"></td>
								<td th:text="${ct.soLuong}"></td>
								<td
									th:text="${#numbers.formatDecimal(ct.giaNhap,0,'COMMA',3,'POINT')}"></td>
								<td
									th:text="${#numbers.formatDecimal(ct.giaNhap * ct.soLuong,0,'COMMA',3,'POINT')}"></td>

								<td><a href="#"
									th:onclick="'editChiTiet(' + ${ct.id} + ')'"
									class="text-primary me-2"><i
										class="fa-solid fa-pen-to-square"></i></a> <a href="#"
									th:onclick="'deleteChiTiet(' + ${ct.id} + ')'"
									class="text-danger"><i class="fa-solid fa-trash"></i></a></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
</body>
</html>
