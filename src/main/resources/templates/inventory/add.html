
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý kho - 4Petals</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link th:href="@{/styles/css/inventory/dashboard.css}" rel="stylesheet">
<link th:href="@{/styles/css/inventory/sidebar.css}" rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
<link
	href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
	rel="stylesheet">
<script>
        // Hàm để tải danh sách đơn hàng bằng AJAX (thay đổi nội dung bảng)
        function showOrders() {
            fetch('/orders/list') // endpoint controller trả về HTML hoặc JSON
                .then(response => response.text())
                .then(html => {
                    document.getElementById('content-section').innerHTML = html;
                });
        }

        function showProducts() {
            fetch('/products/list')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('content-section').innerHTML = html;
                });
        }
    </script>
</head>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<body>
	<div class="dashboard-container">

		<!-- Thanh bên trái -->
		<div th:replace="~{inventory/sidebar :: sidebar}"></div>

		<!-- Nội dung chính -->
		<div class="main-content show">

			<!-- Bảng Phiếu Nhập -->
			<div class="content-box mt-4 mx-3 p-4">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h5 class="fw-bold text-danger">Danh sách Phiếu Nhập</h5>
					<button class="btn btn-success" type="button"
						data-bs-toggle="collapse" data-bs-target="#formPhieuNhap">
						Nhập Phiếu Nhập</button>
				</div>

				<!-- Form nhập phiếu nhập -->
				<div class="collapse mb-3" id="formPhieuNhap">
					<div class="card card-body">
						<form th:action="@{/inventory/add}" method="post">
							<!-- <div class="mb-2">
								<label>Mã Phiếu Nhập</label> <input type="text"
									class="form-control" name="maPN" th:value="${nextMaPhieuNhap}"
									readonly>
							</div> -->
							<div class="mb-2">
								<label>Ngày Nhập</label> <input type="date" class="form-control"
									name="ngayNhap"
									th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
									required>


							</div>

							<div class="mb-2">
								<label>Tổng Tiền</label> <input type="number"
									class="form-control" name="tongTien" th:value="0" readonly>
							</div>
							<div class="mb-2">
								<label>Nhà Cung Cấp</label> <select class="form-select"
									name="maNCC" required>
									<!-- <option value="">Chọn nhà cung cấp</option> -->
									<option th:each="ncc : ${dsNCC}" th:value="${ncc.maNCC}"
										th:text="${ncc.tenNCC}"></option>
								</select>
							</div>

							<!-- <div class="mb-2">
								<label>Nhân Viên Lập Phiếu</label> <input type="text"
									class="form-control" name="tenNV" th:value="${tenNV}" readonly>
								<input type="hidden" name="maNV" th:value="${maNV}">
							</div>  -->

							<button type="submit" class="btn btn-primary">Lưu Phiếu
								Nhập</button>
						</form>
					</div>
				</div>


				<!-- Bảng hiển thị phiếu nhập -->
				<table class="table table-bordered mt-3 align-middle text-center">
					<thead class="table-success">
						<tr>
							<th>STT</th>
							<th>Mã Phiếu Nhập</th>
							<th>Ngày Nhập</th>
							<th>Tổng Tiền</th>
							<th>Nhà Cung Cấp</th>
							<th>Nhân Viên Lập Phiếu</th>
							<th>Thao tác</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="pn, iStat : ${listPhieuNhap}">
							<td th:text="${iStat.count}"></td>
							<td th:text="${pn.maPN}"></td>
							<td th:text="${#temporals.format(pn.ngayNhap, 'yyyy-MM-dd')}"></td>

							<td
								th:text="${#numbers.formatDecimal(pn.tongTien,0,'COMMA',3,'POINT')}"></td>

							<!-- Hiển thị tên nhà cung cấp -->
							<td th:text="${pn.nhaCungCap.tenNCC}"></td>

							<!-- Hiển thị họ tên nhân viên -->
							<td th:text="${pn.nhanVien.hoTen}"></td>

							<td><a href="javascript:void(0)" class="btn btn-info btn-sm"
								th:onclick="'viewPhieuNhapDetail(' + ${pn.maPN} + ')'"> <i
									class="fa-solid fa-eye"></i>
							</a><a href="#" class="text-danger" data-bs-toggle="modal"
								th:attr="data-bs-target='#deletePhieuNhapModal__' + ${pn.maPN}">
									<i class="fa-solid fa-trash"></i>
							</a></td>
						</tr>
					</tbody>
				</table>



				<div th:each="pn : ${listPhieuNhap}"
					th:id="'deletePhieuNhapModal__' + ${pn.maPN}" class="modal fade"
					tabindex="-1">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Xóa Phiếu Nhập</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
							</div>
							<div class="modal-body">
								Bạn có chắc muốn xóa phiếu nhập "<span th:text="${pn.maPN}"></span>"
								không?
							</div>
							<div class="modal-footer">
								<form th:action="@{/inventory/delete}" method="post">
									<input type="hidden" name="maPN" th:value="${pn.maPN}">
									<button type="submit" class="btn btn-danger">Xóa</button>
								</form>
								<button type="button" class="btn btn-secondary"
									data-bs-dismiss="modal">Hủy</button>
							</div>
						</div>
					</div>
				</div>


				<!-- Bảng Chi Tiết Phiếu Nhập -->
				<div class="content-box mt-4 mx-3 p-4">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="fw-bold text-danger">Chi Tiết Phiếu Nhập</h5>
						<button class="btn btn-success" type="button"
							data-bs-toggle="collapse" data-bs-target="#formChiTiet">
							Nhập Chi Tiết Phiếu Nhập</button>
					</div>

					<!-- Form nhập chi tiết phiếu nhập -->
					<div class="collapse mb-3" id="formChiTiet">
						<div class="card card-body">
							<form th:action="@{/inventory/detail/add}" method="post">
								<div class="mb-2">
									<label>Mã Phiếu Nhập</label> <select id="phieuNhap"
										class="form-select" name="phieuNhap" required>
										<!-- <option value="">-- Chọn phiếu nhập --</option> -->
										<option th:each="pn : ${listPhieuNhap}" th:value="${pn.maPN}"
											th:text="${pn.maPN}"></option>
									</select>
								</div>
								<div class="mb-2">
									<label>Nguyên Liệu</label> <select id="nguyenLieu"
										class="form-select" name="nguyenLieu" required>
										<!-- 										<option value="">-- Chọn nguyên liệu --</option> -->
									</select>
								</div>
								<div class="mb-2">
									<label>Số Lượng</label> <input type="number"
										class="form-control" name="soLuong" min="1" required>
								</div>
								<div class="mb-2">
									<label>Giá Nhập</label> <input type="number"
										class="form-control" name="giaNhap" min="0" required>
								</div>
								<button type="submit" class="btn btn-primary">Lưu Chi
									Tiết</button>
							</form>
						</div>
					</div>
					<script th:inline="javascript">
/*<![CDATA[*/
const mapNL = /*[[${mapNguyenLieu}]]*/ {}; // map mã phiếu nhập -> danh sách nguyên liệu

function updateNguyenLieu() {
    const phieuSelect = document.getElementById("phieuNhap");
    const maPN = phieuSelect.value;
    const selectNL = document.getElementById("nguyenLieu");
    selectNL.innerHTML = '<option value=""> </option>';

    if(mapNL[maPN]) {
        mapNL[maPN].forEach(nl => {
            const opt = document.createElement("option");
            opt.value = nl.maNL;      // id nguyên liệu
            opt.textContent = nl.tenNL; // tên nguyên liệu
            selectNL.appendChild(opt);
        });
    }
}

// Gắn sự kiện onchange
document.getElementById("phieuNhap").addEventListener("change", updateNguyenLieu);

// Populate dropdown nguyên liệu ngay khi trang load
updateNguyenLieu();
/*]]>*/
</script>



					<!-- Bảng hiển thị chi tiết phiếu nhập -->
					<table class="table table-bordered mt-3 align-middle text-center">
						<thead class="table-success">
							<tr>
								<th>STT</th>
								<th>Mã Phiếu Nhập</th>
								<th>Tên Nguyên Liệu</th>
								<th>Số Lượng</th>
								<th>Giá Nhập</th>
								<th>Thành Tiền</th>
								<th>Thao Tác</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="ct, iStat : ${listChiTiet}">
								<td th:text="${iStat.count}"></td>
								<td th:text="${ct.phieuNhap.maPN}"></td>
								<td th:text="${ct.nguyenLieu.tenNL}"></td>
								<td th:text="${ct.soLuong}"></td>
								<td
									th:text="${#numbers.formatDecimal(ct.giaNhap,0,'COMMA',3,'POINT')}"></td>
								<td
									th:text="${#numbers.formatDecimal(ct.giaNhap * ct.soLuong,0,'COMMA',3,'POINT')}"></td>

								<td><a href="#"
									th:onclick="'new bootstrap.Modal(document.getElementById(\'editInventoryDetailModal__' + ${ct.maCTPN} + '\')).show()'"
									class="text-primary me-2"> <i
										class="fa-solid fa-pen-to-square"></i>
								</a> <a href="#" class="text-danger" data-bs-toggle="modal"
									th:attr="data-bs-target='#deleteChiTietModal__' + ${ct.maCTPN}">
										<i class="fa-solid fa-trash"></i>
								</a></td>
								<!-- CHÈN: Sửa chi tiết phiếu nhập -->
								<div class="modal fade"
									th:id="'editInventoryDetailModal__' + ${ct.maCTPN}"
									tabindex="-1">
									<div class="modal-dialog">
										<div class="modal-content">
											<form th:action="@{/inventory/detail/edit}" method="post">
												<div class="modal-header">
													<h5 class="modal-title">Sửa chi tiết phiếu nhập</h5>
													<button type="button" class="btn-close"
														data-bs-dismiss="modal"></button>
												</div>
												<div class="modal-body">
													<!-- Hidden: mã chi tiết phiếu nhập và mã phiếu nhập -->
													<input type="hidden" name="maCTPN" th:value="${ct.maCTPN}">
													<input type="hidden" name="maPN"
														th:value="${ct.phieuNhap.maPN}"> <select
														name="maNL" class="form-select" required>
														<option th:each="nl : ${mapNguyenLieu[ct.phieuNhap.maPN]}"
															th:value="${nl.maNL}" th:text="${nl.tenNL}"
															th:selected="${nl.maNL} == ${ct.nguyenLieu.maNL}">
														</option>
													</select>



													<div class="mb-3">
														<label class="form-label">Số lượng</label> <input
															type="number" name="soLuong" class="form-control"
															th:value="${ct.soLuong}" min="1" required>
													</div>

													<div class="mb-3">
														<label class="form-label">Giá nhập</label> <input
															type="number" name="giaNhap" class="form-control"
															th:value="${ct.giaNhap}" min="0" step="0.01" required>
													</div>
												</div>
												<div class="modal-footer">
													<button type="submit" class="btn btn-primary">Lưu</button>
													<button type="button" class="btn btn-secondary"
														data-bs-dismiss="modal">Hủy</button>
												</div>
											</form>
										</div>
									</div>
								</div>
								<!-- CHÈN END -->

							</tr>
						</tbody>
					</table>
					<!-- Modal xóa Chi Tiết Phiếu Nhập  -->
					<div th:each="ct : ${listChiTiet}"
						th:id="'deleteChiTietModal__' + ${ct.maCTPN}" class="modal fade"
						tabindex="-1">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title">Xóa Chi Tiết Phiếu Nhập</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
								</div>
								<div class="modal-body">
									<!-- Bạn có chắc muốn xóa chi tiết phiếu nhập "<span
										th:text="${ct.maCTPN}"></span>" không? -->
									Bạn có chắc muốn xóa chi tiết phiếu nhập này không?
								</div>
								<div class="modal-footer">
									<form th:action="@{/inventory/detail/delete}" method="post">
										<input type="hidden" name="maCTPN" th:value="${ct.maCTPN}">
										<button type="submit" class="btn btn-danger">Xóa</button>
									</form>
									<button type="button" class="btn btn-secondary"
										data-bs-dismiss="modal">Hủy</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="phieuNhapDetailModal" tabindex="-1"
			aria-labelledby="phieuNhapDetailLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title" id="phieuNhapDetailLabel">Chi tiết
							phiếu nhập</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Đóng"></button>
					</div>
					<div class="modal-body">
						<table class="table table-bordered table-hover">
							<thead class="table-light">
								<tr>
									<th>STT</th>
									<th>Tên nguyên liệu</th>
									<th>Số lượng</th>
									<th>Giá nhập</th>
									<th>Thành tiền</th>
								</tr>
							</thead>
							<tbody id="phieuNhap-detail-body"></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<script>
function viewPhieuNhapDetail(maPN) {
    const tbody = document.getElementById("phieuNhap-detail-body");
    tbody.innerHTML = ""; // Xóa nội dung cũ

    fetch(`/inventory/detail/${maPN}`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Không có chi tiết phiếu nhập</td></tr>`;
                return;
            }

            data.forEach((ct, index) => {
                const soLuong = Number(ct.soLuong);
                const giaNhap = Number(ct.giaNhap); 
                const thanhTien = Number(ct.thanhTien ?? soLuong * giaNhap);

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${ct.nguyenLieu.tenNL}</td>
                    <td>${soLuong}</td>
                    <td>${giaNhap.toLocaleString()}</td>
                    <td>${thanhTien.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error("Lỗi khi tải chi tiết phiếu nhập:", error);
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>`;
        });

    // Hiển thị modal sau khi dữ liệu sẵn sàng
    const modal = new bootstrap.Modal(document.getElementById('phieuNhapDetailModal'));
    modal.show();
}
</script>
</body>
</html>