<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layout}">
<head>
<title>Phân quyền chức năng</title>
<th:block layout:fragment="styles">
	<link rel="stylesheet" href="/styles/css/admin/main.css">
</th:block>
</head>
<body>
	<div layout:fragment="content">

		<!-- Tìm kiếm + Lọc -->
		<div class="search-filter-container">
			<form th:action="@{/admin/permissions}" method="get">
				<div class="search-box">
					<input type="text" name="keyword"
						placeholder="Tìm kiếm theo tên, email, hoặc username..."
						th:value="${keyword}">
					<button type="submit">
						<i class="fas fa-search"></i> Tìm kiếm
					</button>
				</div>

				<div class="filter-group">
					<div class="filter-item">
						<label for="statusFilter">Trạng thái:</label> <select
							id="statusFilter" name="status" onchange="this.form.submit()">
							<option value="">Tất cả</option>
							<option value="1" th:selected="${status == '1'}">Hoạt
								động</option>
							<option value="0" th:selected="${status == '0'}">Ngừng
								hoạt động</option>
							<option value="-1" th:selected="${status == '-1'}">Bị
								khóa</option>
						</select>
					</div>
					<div class="filter-item">
						<label for="roleFilter">Vai trò:</label> <select id="roleFilter"
							name="roleId" onchange="this.form.submit()">
							<option value="">Tất cả</option>
							<option th:each="role : ${roles}" th:value="${role.roleId}"
								th:text="${role.roleName.displayName}"
								th:selected="${roleId == role.roleId}"></option>
						</select>
					</div>
				</div>
			</form>
		</div>

		<!-- Bảng người dùng + phân quyền -->
		<div class="table-users">
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>Username</th>
						<th>Họ tên</th>
						<th>Email</th>
						<th>Số điện thoại</th>
						<th>Vai trò hiện tại</th>
						<th>Gán vai trò</th>
						<th>Trạng thái</th>
						<th>Hành động</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="user : ${users}">
						<td th:text="${user.userId}">#001</td>
						<td th:text="${user.username}">username</td>
						<td
							th:text="${user.khachHang != null ? user.khachHang.hoTen : (user.nhanVien != null ? user.nhanVien.hoTen : 'N/A')}">Họ
							tên</td>
						<td th:text="${user.email}">email@example.com</td>
						<td
							th:text="${user.khachHang != null ? user.khachHang.sdt : (user.nhanVien != null ? user.nhanVien.sdt : 'Chưa cập nhật')}">0901234567</td>
						<td
							th:text="${user.role != null ? user.role.roleName.displayName : 'N/A'}">Role</td>

						<!-- Dropdown gán vai trò -->
						<td>
							<form th:action="@{/admin/permissions/assign-role}" method="post">
								<input type="hidden" name="userId" th:value="${user.userId}" />
								<select name="roleId">
									<option th:each="role : ${roles}" th:value="${role.roleId}"
										th:text="${role.roleName.displayName}"
										th:selected="${user.role != null and user.role.roleId == role.roleId}"></option>
								</select>
								<button type="submit" class="btn-assign">Gán</button>
							</form>
						</td>

						<td class="toggle-cell"><label class="switch"> <input
								type="checkbox" th:checked="${user.status == 1}"
								th:data-id="${user.userId}" onchange="toggleStatus(this)">
								<span class="slider round"></span>
						</label></td>

						<td>
							<div class="action-buttons">
								<a th:href="@{'/admin/users/view/' + ${user.userId}}"
									class="btn-view"><i class="fas fa-eye"></i></a> <a
									th:href="@{'/admin/users/edit/' + ${user.userId}}"
									class="btn-edit"><i class="fas fa-edit"></i></a> <a
									th:href="@{'/admin/users/delete/' + ${user.userId}}"
									class="btn-delete"
									onclick="return confirm('Bạn có chắc chắn muốn xóa người dùng này?');"><i
									class="fas fa-trash"></i></a>
							</div>
						</td>
					</tr>

					<tr th:if="${users == null || users.isEmpty()}">
						<td colspan="9" style="text-align: center;">Không có người
							dùng nào được tìm thấy</td>
					</tr>
				</tbody>
			</table>
		</div>


	</div>

	<th:block layout:fragment="scripts">
		<script>
        function toggleStatus(checkbox) {
            const userId = checkbox.getAttribute('data-id');
            fetch('/admin/users/toggle-status/' + userId)
                .then(() => location.reload())
                .catch(err => console.error(err));
        }
    </script>
	</th:block>

</body>
</html>
